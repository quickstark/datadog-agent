# Synology-Compatible Datadog Agent Configuration
# This version disables problematic features that cause container lock-up on Synology NAS systems

# Stage 1: Builder
FROM datadog/agent:latest AS builder

# Install PostgreSQL dependencies
RUN pip3 install --no-cache-dir psycopg2-binary

# Stage 2: Final
FROM datadog/agent:latest

# Set required labels
LABEL maintainer="Dirk" \
    description="Synology-Compatible Datadog Agent with PostgreSQL and MongoDB monitoring"

# SYNOLOGY-COMPATIBLE ENVIRONMENT VARIABLES
# Key changes: Disabled runtime security, system probe, and compliance features
ENV DD_SITE=datadoghq.com \
    DD_HOSTNAME=Synology \
    DD_APM_ENABLED=true \
    DD_LOGS_ENABLED=true \
    DD_PROCESS_AGENT_ENABLED=true \
    DD_SYSTEM_PROBE_NETWORK_ENABLED=false \
    DD_RUNTIME_SECURITY_CONFIG_ENABLED=false \
    DD_COMPLIANCE_CONFIG_ENABLED=false \
    DD_SYSTEM_PROBE_ENABLED=false \
    DD_PROCESS_CONFIG_PROCESS_COLLECTION_ENABLED=true \
    DD_PROCESS_CONFIG_CONTAINER_COLLECTION_ENABLED=true \
    DD_LOGS_CONFIG_LOGS_DD_URL=http://192.168.1.100:8282 \
    DD_LOGS_CONFIG_USE_HTTP=true \
    DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true \
    DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true \
    DD_ENABLE_METADATA_COLLECTION=true \
    DD_LOG_LEVEL=info \
    DD_CMD_PORT=5002 \
    DD_EXPVAR_PORT=5003 \
    DD_APM_DD_URL=http://192.168.1.100:3835 \
    DD_APM_NON_LOCAL_TRAFFIC=true \
    DD_APM_ENV=dev \
    DD_INVENTORIES_CONFIGURATION_ENABLED=true \
    DD_REMOTE_UPDATES=true \
    DD_TAGS=env:dev,deployment:synology,mode:synology-compatible \
    PUID=1026 \
    PGID=100 \
    TZ=America/Chicago \
    ACCEPT_EULA=Y

# Install PostgreSQL and SQL Server (ODBC via FreeTDS) dependencies in the final stage
RUN pip3 install --no-cache-dir psycopg2-binary \
 && apt-get update \
 && apt-get install -y --no-install-recommends unixodbc unixodbc-dev freetds-dev freetds-bin tdsodbc \
 && pip3 install --no-cache-dir pyodbc \
 && rm -rf /var/lib/apt/lists/*

# Synology-compatible configuration files
# These exclude problematic system-probe.yaml and security-agent.yaml
# Configuration files are managed via volume mounts during deployment:
# - /volume1/docker/datadog-agent/datadog.yaml:/etc/datadog-agent/datadog.yaml:ro
# - /volume1/docker/datadog-agent/conf.d:/etc/datadog-agent/conf.d:ro
# NOTE: security-agent.yaml and system-probe.yaml are intentionally excluded

# Expose ports (reduced set for Synology compatibility)
EXPOSE 8125/udp 8126/tcp 5002/tcp 5003/tcp

# Set healthcheck
HEALTHCHECK --interval=30s --timeout=10s --retries=3 CMD ["/opt/datadog-agent/bin/agent/agent", "health"]

# SYNOLOGY-COMPATIBLE VOLUME MOUNTS
# Reduced set of volumes to avoid kernel-level conflicts
VOLUME ["/var/run/docker.sock", "/host/proc", "/host/sys/fs/cgroup", "/etc/passwd", "/var/lib/docker/containers"]

# SYNOLOGY-COMPATIBLE RUNTIME REQUIREMENTS:
# 
# Required volume mounts (safe for Synology):
# - /var/run/docker.sock:/var/run/docker.sock:ro (Docker monitoring)
# - /proc:/host/proc:ro (System metrics)
# - /sys/fs/cgroup:/host/sys/fs/cgroup:ro (Container metrics)
# - /etc/passwd:/etc/passwd:ro (User mapping)
# - /volume1/@docker/containers:/var/lib/docker/containers:ro (Container logs)
# - /volume1/docker/datadog-agent/datadog.yaml:/etc/datadog-agent/datadog.yaml:ro
# - /volume1/docker/datadog-agent/conf.d:/etc/datadog-agent/conf.d:ro
#
# EXCLUDED MOUNTS (cause container lock-up on Synology):
# - /sys/kernel/debug:/sys/kernel/debug (System probe requirement)
#
# SYNOLOGY-SAFE CAPABILITIES (use instead of --privileged):
# --cap-add CHOWN --cap-add DAC_OVERRIDE --cap-add SETGID --cap-add SETUID
#
# EXCLUDED CAPABILITIES (cause namespace corruption on Synology):
# - SYS_ADMIN (system probe requirement)
# - SYS_RESOURCE (compliance requirement) 
# - SYS_PTRACE (runtime security requirement)
# - NET_ADMIN (network probe requirement)
# - NET_BROADCAST (network monitoring)
# - NET_RAW (packet capture)
# - IPC_LOCK (memory locking)
#
# Security options: --security-opt no-new-privileges=true